<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Core CRUD Systems Test - D'Avila Reis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 40px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f9fafb;
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .section-header h3 {
            color: #1f2937;
            font-size: 1.25rem;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-badge.success { background: #dcfce7; color: #166534; }
        .status-badge.error { background: #fef2f2; color: #dc2626; }
        .status-badge.running { background: #fef3c7; color: #d97706; }
        .status-badge.pending { background: #f3f4f6; color: #6b7280; }
        
        .section-content {
            padding: 20px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .test-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            background: #fafafa;
        }
        
        .test-card h4 {
            color: #1f2937;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        button.secondary {
            background: #6b7280;
        }
        
        button.secondary:hover {
            background: #4b5563;
        }
        
        button.success {
            background: #10b981;
        }
        
        button.success:hover {
            background: #059669;
        }
        
        button.danger {
            background: #ef4444;
        }
        
        button.danger:hover {
            background: #dc2626;
        }
        
        .results {
            margin-top: 20px;
            padding: 15px;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 4px solid #3b82f6;
        }
        
        .results pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .log {
            height: 200px;
            overflow-y: auto;
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border-radius: 6px;
            margin-top: 15px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .log-entry.success { color: #10b981; }
        .log-entry.error { color: #ef4444; }
        .log-entry.warning { color: #f59e0b; }
        .log-entry.info { color: #3b82f6; }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèóÔ∏è Core CRUD Systems Test</h1>
            <p>Testing Document Management, Case Management, and Client Registration Workflows</p>
        </div>
        
        <div class="content">
            <!-- Test Statistics -->
            <div class="test-section">
                <div class="section-header">
                    <h3>üìä Test Overview</h3>
                    <span id="overall-status" class="status-badge pending">Ready</span>
                </div>
                <div class="section-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-tests">0</div>
                            <div class="stat-label">Total Tests</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="passed-tests">0</div>
                            <div class="stat-label">Passed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="failed-tests">0</div>
                            <div class="stat-label">Failed</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="success-rate">0%</div>
                            <div class="stat-label">Success Rate</div>
                        </div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    
                    <button onclick="runAllTests()">üöÄ Run All Tests</button>
                    <button onclick="clearResults()" class="secondary">üßπ Clear Results</button>
                    <button onclick="exportResults()" class="success">üìä Export Results</button>
                </div>
            </div>

            <!-- Case Management Tests -->
            <div class="test-section">
                <div class="section-header">
                    <h3>‚öñÔ∏è Case Management CRUD</h3>
                    <span id="case-status" class="status-badge pending">Ready</span>
                </div>
                <div class="section-content">
                    <div class="two-column">
                        <div>
                            <h4>Create Case Test</h4>
                            <div class="form-group">
                                <label>Client ID (UUID)</label>
                                <input type="text" id="test-client-id" placeholder="Enter valid client ID" />
                            </div>
                            <div class="form-group">
                                <label>Case Title</label>
                                <input type="text" id="test-case-title" value="Caso Teste - Direito Trabalhista" />
                            </div>
                            <div class="form-group">
                                <label>Service Type</label>
                                <select id="test-service-type">
                                    <option value="Direito Trabalhista">Direito Trabalhista</option>
                                    <option value="Direito Civil">Direito Civil</option>
                                    <option value="Direito Empresarial">Direito Empresarial</option>
                                </select>
                            </div>
                            <button onclick="testCreateCase()">Create Case</button>
                            <button onclick="testUpdateCase()" id="update-case-btn" disabled>Update Case</button>
                            <button onclick="testDeleteCase()" id="delete-case-btn" disabled class="danger">Delete Case</button>
                        </div>
                        <div>
                            <h4>Case Operations Tests</h4>
                            <button onclick="testGetCases()">List All Cases</button>
                            <button onclick="testGetCaseById()">Get Case by ID</button>
                            <button onclick="testCaseFilters()">Test Filters</button>
                            <button onclick="testCaseStatistics()">Get Statistics</button>
                            <button onclick="testUpdateProgress()">Update Progress</button>
                            <button onclick="testCloseCase()">Close Case</button>
                        </div>
                    </div>
                    <div class="results" id="case-results" style="display: none;">
                        <h5>Results:</h5>
                        <pre id="case-output"></pre>
                    </div>
                </div>
            </div>

            <!-- Document Management Tests -->
            <div class="test-section">
                <div class="section-header">
                    <h3>üìé Document Management & Case Attachment</h3>
                    <span id="document-status" class="status-badge pending">Ready</span>
                </div>
                <div class="section-content">
                    <div class="two-column">
                        <div>
                            <h4>Document Upload Test</h4>
                            <div class="form-group">
                                <label>Document Name</label>
                                <input type="text" id="test-doc-name" value="Teste - Contrato de Trabalho" />
                            </div>
                            <div class="form-group">
                                <label>Document Type</label>
                                <select id="test-doc-type">
                                    <option value="contract">Contrato</option>
                                    <option value="evidence">Evid√™ncia</option>
                                    <option value="correspondence">Correspond√™ncia</option>
                                    <option value="court_filing">Peti√ß√£o</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Test File (simulated)</label>
                                <input type="file" id="test-file" accept=".pdf,.doc,.docx" />
                            </div>
                            <button onclick="testUploadDocument()">Upload Document</button>
                            <button onclick="testAttachToCase()" id="attach-doc-btn" disabled>Attach to Case</button>
                        </div>
                        <div>
                            <h4>Document Operations</h4>
                            <button onclick="testListDocuments()">List Documents</button>
                            <button onclick="testDocumentsByCase()">Documents by Case</button>
                            <button onclick="testDocumentFilters()">Test Filters</button>
                            <button onclick="testDocumentVisibility()">Toggle Visibility</button>
                            <button onclick="testDocumentStatus()">Update Status</button>
                            <button onclick="testDocumentStatistics()">Get Statistics</button>
                        </div>
                    </div>
                    <div class="results" id="document-results" style="display: none;">
                        <h5>Results:</h5>
                        <pre id="document-output"></pre>
                    </div>
                </div>
            </div>

            <!-- Client Registration Tests -->
            <div class="test-section">
                <div class="section-header">
                    <h3>üë• Client Registration Approval Workflow</h3>
                    <span id="registration-status" class="status-badge pending">Ready</span>
                </div>
                <div class="section-content">
                    <div class="two-column">
                        <div>
                            <h4>Registration Submission Test</h4>
                            <div class="form-group">
                                <label>Company Name</label>
                                <input type="text" id="test-company" value="Empresa Teste LTDA" />
                            </div>
                            <div class="form-group">
                                <label>Contact Person</label>
                                <input type="text" id="test-contact" value="Jo√£o Silva" />
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="test-email" value="joao@empresateste.com" />
                            </div>
                            <div class="form-group">
                                <label>Phone</label>
                                <input type="text" id="test-phone" value="(11) 99999-9999" />
                            </div>
                            <button onclick="testSubmitRegistration()">Submit Registration</button>
                            <button onclick="testApproveRegistration()" id="approve-reg-btn" disabled class="success">Approve</button>
                            <button onclick="testRejectRegistration()" id="reject-reg-btn" disabled class="danger">Reject</button>
                        </div>
                        <div>
                            <h4>Registration Management</h4>
                            <button onclick="testGetRegistrations()">List Registrations</button>
                            <button onclick="testRegistrationFilters()">Test Filters</button>
                            <button onclick="testRegistrationStats()">Get Statistics</button>
                            <button onclick="testRegistrationHistory()">View History</button>
                            <button onclick="testBulkApproval()">Bulk Operations</button>
                            <button onclick="testRegistrationSearch()">Search Function</button>
                        </div>
                    </div>
                    <div class="results" id="registration-results" style="display: none;">
                        <h5>Results:</h5>
                        <pre id="registration-output"></pre>
                    </div>
                </div>
            </div>

            <!-- Integration Tests -->
            <div class="test-section">
                <div class="section-header">
                    <h3>üîó Integration & Workflow Tests</h3>
                    <span id="integration-status" class="status-badge pending">Ready</span>
                </div>
                <div class="section-content">
                    <div class="test-grid">
                        <div class="test-card">
                            <h4>End-to-End Workflow</h4>
                            <button onclick="testCompleteWorkflow()">Run E2E Test</button>
                            <p>Tests complete workflow: Registration ‚Üí Approval ‚Üí Case Creation ‚Üí Document Upload ‚Üí Case Management</p>
                        </div>
                        <div class="test-card">
                            <h4>Performance Tests</h4>
                            <button onclick="testPerformance()">Performance Test</button>
                            <p>Tests response times and bulk operations</p>
                        </div>
                        <div class="test-card">
                            <h4>Error Handling</h4>
                            <button onclick="testErrorHandling()">Error Tests</button>
                            <p>Tests error scenarios and validation</p>
                        </div>
                        <div class="test-card">
                            <h4>Data Validation</h4>
                            <button onclick="testDataValidation()">Validation Tests</button>
                            <p>Tests input validation and data integrity</p>
                        </div>
                    </div>
                    <div class="results" id="integration-results" style="display: none;">
                        <h5>Results:</h5>
                        <pre id="integration-output"></pre>
                    </div>
                </div>
            </div>

            <!-- Test Log -->
            <div class="test-section">
                <div class="section-header">
                    <h3>üìã Test Execution Log</h3>
                    <button onclick="clearLog()" class="secondary">Clear Log</button>
                </div>
                <div class="section-content">
                    <div class="log" id="test-log"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Test state
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            results: []
        };

        let createdCaseId = null;
        let createdDocumentId = null;
        let createdRegistrationId = null;

        // Utility functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            const logElement = document.getElementById('test-log');
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateStats() {
            document.getElementById('total-tests').textContent = testResults.total;
            document.getElementById('passed-tests').textContent = testResults.passed;
            document.getElementById('failed-tests').textContent = testResults.failed;
            
            const successRate = testResults.total > 0 ? Math.round((testResults.passed / testResults.total) * 100) : 0;
            document.getElementById('success-rate').textContent = `${successRate}%`;
            
            const progress = testResults.total > 0 ? (testResults.passed / testResults.total) * 100 : 0;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        function showResults(sectionId, outputId, result) {
            document.getElementById(sectionId).style.display = 'block';
            document.getElementById(outputId).textContent = JSON.stringify(result, null, 2);
        }

        async function runTest(testName, testFunction) {
            try {
                log(`Starting ${testName}...`, 'info');
                const result = await testFunction();
                
                testResults.total++;
                testResults.passed++;
                testResults.results.push({ test: testName, status: 'PASS', result });
                
                log(`‚úÖ ${testName} PASSED`, 'success');
                updateStats();
                return result;
            } catch (error) {
                testResults.total++;
                testResults.failed++;
                testResults.results.push({ test: testName, status: 'FAIL', error: error.message });
                
                log(`‚ùå ${testName} FAILED: ${error.message}`, 'error');
                updateStats();
                throw error;
            }
        }

        // Mock service functions (since we can't access the actual services in this HTML file)
        const mockCaseService = {
            async createCase(data) {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 500));
                const mockCase = {
                    id: 'case_' + Date.now(),
                    case_number: 'CASO-2025-' + Math.random().toString(36).substr(2, 6).toUpperCase(),
                    ...data,
                    status: 'Open',
                    progress_percentage: 0,
                    created_at: new Date().toISOString()
                };
                createdCaseId = mockCase.id;
                return mockCase;
            },

            async updateCase(caseId, data) {
                await new Promise(resolve => setTimeout(resolve, 300));
                return { id: caseId, ...data, updated_at: new Date().toISOString() };
            },

            async deleteCase(caseId) {
                await new Promise(resolve => setTimeout(resolve, 200));
                return { success: true };
            },

            async getCases(filters = {}) {
                await new Promise(resolve => setTimeout(resolve, 400));
                return [
                    { id: 'case1', case_title: 'Caso Exemplo 1', status: 'Open' },
                    { id: 'case2', case_title: 'Caso Exemplo 2', status: 'In Progress' }
                ];
            },

            async getCaseById(caseId) {
                await new Promise(resolve => setTimeout(resolve, 300));
                return { id: caseId, case_title: 'Caso Detalhado', status: 'Open' };
            },

            async getCaseStatistics() {
                await new Promise(resolve => setTimeout(resolve, 200));
                return { total: 50, open: 20, inProgress: 15, closed: 15, avgProgressPercentage: 65 };
            }
        };

        const mockDocumentService = {
            async uploadDocument(data) {
                await new Promise(resolve => setTimeout(resolve, 800));
                const mockDoc = {
                    id: 'doc_' + Date.now(),
                    document_name: data.document_name,
                    document_type: data.document_type,
                    file_url: 'https://example.com/documents/test.pdf',
                    status: 'Draft',
                    created_at: new Date().toISOString()
                };
                createdDocumentId = mockDoc.id;
                return mockDoc;
            },

            async attachDocumentToCase(docId, caseId) {
                await new Promise(resolve => setTimeout(resolve, 300));
                return { id: docId, case_id: caseId, attached_at: new Date().toISOString() };
            },

            async getDocuments(filters = {}) {
                await new Promise(resolve => setTimeout(resolve, 400));
                return [
                    { id: 'doc1', document_name: 'Contrato 1', status: 'Approved' },
                    { id: 'doc2', document_name: 'Evid√™ncia 1', status: 'Draft' }
                ];
            },

            async getDocumentStatistics() {
                await new Promise(resolve => setTimeout(resolve, 200));
                return {
                    total: 150,
                    by_type: { contract: 50, evidence: 40, correspondence: 60 },
                    by_status: { Draft: 30, Approved: 100, Archived: 20 },
                    recent_uploads: 25,
                    pending_signatures: 10
                };
            }
        };

        const mockRegistrationService = {
            async submitRegistration(data) {
                await new Promise(resolve => setTimeout(resolve, 600));
                const mockReg = {
                    id: 'reg_' + Date.now(),
                    ...data,
                    registration_status: 'pending',
                    registration_date: new Date().toISOString()
                };
                createdRegistrationId = mockReg.id;
                return mockReg;
            },

            async updateRegistrationStatus(regId, approvalData) {
                await new Promise(resolve => setTimeout(resolve, 400));
                return { id: regId, registration_status: approvalData.status, updated_at: new Date().toISOString() };
            },

            async getRegistrationStats() {
                await new Promise(resolve => setTimeout(resolve, 300));
                return {
                    total: 100,
                    pending: 15,
                    approved: 70,
                    rejected: 10,
                    under_review: 5,
                    this_month: 20,
                    avg_approval_time: 3
                };
            },

            async searchRegistrations(filters) {
                await new Promise(resolve => setTimeout(resolve, 400));
                return [
                    { id: 'reg1', company_name: 'Empresa A', registration_status: 'pending' },
                    { id: 'reg2', company_name: 'Empresa B', registration_status: 'approved' }
                ];
            }
        };

        // Case Management Tests
        async function testCreateCase() {
            const clientId = document.getElementById('test-client-id').value || 'client_test_123';
            const caseTitle = document.getElementById('test-case-title').value;
            const serviceType = document.getElementById('test-service-type').value;

            const result = await runTest('Create Case', async () => {
                return await mockCaseService.createCase({
                    client_id: clientId,
                    case_title: caseTitle,
                    service_type: serviceType,
                    description: 'Caso de teste criado automaticamente',
                    priority: 'Medium'
                });
            });

            showResults('case-results', 'case-output', result);
            
            // Enable dependent buttons
            document.getElementById('update-case-btn').disabled = false;
            document.getElementById('delete-case-btn').disabled = false;
        }

        async function testUpdateCase() {
            if (!createdCaseId) {
                throw new Error('No case created yet. Create a case first.');
            }

            const result = await runTest('Update Case', async () => {
                return await mockCaseService.updateCase(createdCaseId, {
                    progress_percentage: 50,
                    notes: 'Caso atualizado via teste automatizado'
                });
            });

            showResults('case-results', 'case-output', result);
        }

        async function testDeleteCase() {
            if (!createdCaseId) {
                throw new Error('No case created yet. Create a case first.');
            }

            const result = await runTest('Delete Case', async () => {
                return await mockCaseService.deleteCase(createdCaseId);
            });

            showResults('case-results', 'case-output', result);
            createdCaseId = null;
            
            // Disable dependent buttons
            document.getElementById('update-case-btn').disabled = true;
            document.getElementById('delete-case-btn').disabled = true;
        }

        async function testGetCases() {
            const result = await runTest('Get Cases', async () => {
                return await mockCaseService.getCases();
            });

            showResults('case-results', 'case-output', result);
        }

        async function testGetCaseById() {
            const caseId = createdCaseId || 'test_case_id';
            
            const result = await runTest('Get Case by ID', async () => {
                return await mockCaseService.getCaseById(caseId);
            });

            showResults('case-results', 'case-output', result);
        }

        async function testCaseFilters() {
            const result = await runTest('Case Filters', async () => {
                return await mockCaseService.getCases({
                    status: 'Open',
                    priority: 'High',
                    search_query: 'teste'
                });
            });

            showResults('case-results', 'case-output', result);
        }

        async function testCaseStatistics() {
            const result = await runTest('Case Statistics', async () => {
                return await mockCaseService.getCaseStatistics();
            });

            showResults('case-results', 'case-output', result);
        }

        async function testUpdateProgress() {
            const caseId = createdCaseId || 'test_case_id';
            
            const result = await runTest('Update Progress', async () => {
                return await mockCaseService.updateCase(caseId, {
                    progress_percentage: 75
                });
            });

            showResults('case-results', 'case-output', result);
        }

        async function testCloseCase() {
            const caseId = createdCaseId || 'test_case_id';
            
            const result = await runTest('Close Case', async () => {
                return await mockCaseService.updateCase(caseId, {
                    status: 'Closed - Won',
                    outcome: 'Caso encerrado com sucesso',
                    progress_percentage: 100
                });
            });

            showResults('case-results', 'case-output', result);
        }

        // Document Management Tests
        async function testUploadDocument() {
            const docName = document.getElementById('test-doc-name').value;
            const docType = document.getElementById('test-doc-type').value;
            const clientId = document.getElementById('test-client-id').value || 'client_test_123';

            const result = await runTest('Upload Document', async () => {
                return await mockDocumentService.uploadDocument({
                    client_id: clientId,
                    document_name: docName,
                    document_type: docType,
                    document_category: 'legal',
                    is_visible_to_client: false
                });
            });

            showResults('document-results', 'document-output', result);
            
            // Enable dependent buttons
            document.getElementById('attach-doc-btn').disabled = false;
        }

        async function testAttachToCase() {
            if (!createdDocumentId || !createdCaseId) {
                throw new Error('Need both document and case created first.');
            }

            const result = await runTest('Attach Document to Case', async () => {
                return await mockDocumentService.attachDocumentToCase(createdDocumentId, createdCaseId);
            });

            showResults('document-results', 'document-output', result);
        }

        async function testListDocuments() {
            const result = await runTest('List Documents', async () => {
                return await mockDocumentService.getDocuments();
            });

            showResults('document-results', 'document-output', result);
        }

        async function testDocumentsByCase() {
            const caseId = createdCaseId || 'test_case_id';
            
            const result = await runTest('Documents by Case', async () => {
                return await mockDocumentService.getDocuments({ case_id: caseId });
            });

            showResults('document-results', 'document-output', result);
        }

        async function testDocumentFilters() {
            const result = await runTest('Document Filters', async () => {
                return await mockDocumentService.getDocuments({
                    document_type: 'contract',
                    status: 'Approved',
                    is_visible_to_client: true
                });
            });

            showResults('document-results', 'document-output', result);
        }

        async function testDocumentVisibility() {
            const docId = createdDocumentId || 'test_doc_id';
            
            const result = await runTest('Document Visibility', async () => {
                // Mock visibility toggle
                return { id: docId, is_visible_to_client: true, updated_at: new Date().toISOString() };
            });

            showResults('document-results', 'document-output', result);
        }

        async function testDocumentStatus() {
            const docId = createdDocumentId || 'test_doc_id';
            
            const result = await runTest('Document Status', async () => {
                // Mock status update
                return { id: docId, status: 'Approved', updated_at: new Date().toISOString() };
            });

            showResults('document-results', 'document-output', result);
        }

        async function testDocumentStatistics() {
            const result = await runTest('Document Statistics', async () => {
                return await mockDocumentService.getDocumentStatistics();
            });

            showResults('document-results', 'document-output', result);
        }

        // Registration Tests
        async function testSubmitRegistration() {
            const company = document.getElementById('test-company').value;
            const contact = document.getElementById('test-contact').value;
            const email = document.getElementById('test-email').value;
            const phone = document.getElementById('test-phone').value;

            const result = await runTest('Submit Registration', async () => {
                return await mockRegistrationService.submitRegistration({
                    company_name: company,
                    contact_person: contact,
                    email: email,
                    phone: phone,
                    cnpj: '12.345.678/0001-99',
                    industry: 'Tecnologia',
                    urgency_level: 'normal',
                    marketing_consent: true,
                    data_processing_consent: true,
                    preferred_contact_method: 'email'
                });
            });

            showResults('registration-results', 'registration-output', result);
            
            // Enable dependent buttons
            document.getElementById('approve-reg-btn').disabled = false;
            document.getElementById('reject-reg-btn').disabled = false;
        }

        async function testApproveRegistration() {
            if (!createdRegistrationId) {
                throw new Error('No registration created yet. Submit a registration first.');
            }

            const result = await runTest('Approve Registration', async () => {
                return await mockRegistrationService.updateRegistrationStatus(createdRegistrationId, {
                    status: 'approved',
                    reason: 'Documenta√ß√£o completa e verificada',
                    portal_access: true
                });
            });

            showResults('registration-results', 'registration-output', result);
        }

        async function testRejectRegistration() {
            if (!createdRegistrationId) {
                throw new Error('No registration created yet. Submit a registration first.');
            }

            const result = await runTest('Reject Registration', async () => {
                return await mockRegistrationService.updateRegistrationStatus(createdRegistrationId, {
                    status: 'rejected',
                    reason: 'Documenta√ß√£o incompleta',
                    portal_access: false
                });
            });

            showResults('registration-results', 'registration-output', result);
        }

        async function testGetRegistrations() {
            const result = await runTest('Get Registrations', async () => {
                return await mockRegistrationService.searchRegistrations({});
            });

            showResults('registration-results', 'registration-output', result);
        }

        async function testRegistrationFilters() {
            const result = await runTest('Registration Filters', async () => {
                return await mockRegistrationService.searchRegistrations({
                    status: 'pending',
                    industry: 'Tecnologia',
                    urgency_level: 'high'
                });
            });

            showResults('registration-results', 'registration-output', result);
        }

        async function testRegistrationStats() {
            const result = await runTest('Registration Statistics', async () => {
                return await mockRegistrationService.getRegistrationStats();
            });

            showResults('registration-results', 'registration-output', result);
        }

        async function testRegistrationHistory() {
            const regId = createdRegistrationId || 'test_reg_id';
            
            const result = await runTest('Registration History', async () => {
                // Mock history
                return [
                    { status: 'pending', created_at: new Date().toISOString(), change_reason: 'Initial submission' },
                    { status: 'under_review', created_at: new Date().toISOString(), change_reason: 'Under review by admin' }
                ];
            });

            showResults('registration-results', 'registration-output', result);
        }

        async function testBulkApproval() {
            const result = await runTest('Bulk Operations', async () => {
                // Mock bulk approval
                return {
                    processed: 5,
                    successful: 4,
                    failed: 1,
                    results: [
                        { id: 'reg1', success: true },
                        { id: 'reg2', success: true },
                        { id: 'reg3', success: false, error: 'Invalid data' }
                    ]
                };
            });

            showResults('registration-results', 'registration-output', result);
        }

        async function testRegistrationSearch() {
            const result = await runTest('Registration Search', async () => {
                return await mockRegistrationService.searchRegistrations({
                    search_query: 'teste',
                    date_from: '2025-01-01',
                    date_to: '2025-12-31'
                });
            });

            showResults('registration-results', 'registration-output', result);
        }

        // Integration Tests
        async function testCompleteWorkflow() {
            const result = await runTest('Complete E2E Workflow', async () => {
                // Step 1: Submit registration
                const registration = await mockRegistrationService.submitRegistration({
                    company_name: 'Workflow Test Company',
                    contact_person: 'Test User',
                    email: 'test@workflow.com',
                    phone: '(11) 99999-9999',
                    marketing_consent: true,
                    data_processing_consent: true,
                    preferred_contact_method: 'email',
                    urgency_level: 'normal'
                });

                // Step 2: Approve registration
                await mockRegistrationService.updateRegistrationStatus(registration.id, {
                    status: 'approved',
                    portal_access: true
                });

                // Step 3: Create case
                const case_ = await mockCaseService.createCase({
                    client_id: registration.id,
                    case_title: 'Workflow Test Case',
                    service_type: 'Direito Trabalhista'
                });

                // Step 4: Upload and attach document
                const document = await mockDocumentService.uploadDocument({
                    client_id: registration.id,
                    document_name: 'Workflow Test Document',
                    document_type: 'contract'
                });

                await mockDocumentService.attachDocumentToCase(document.id, case_.id);

                return {
                    registration,
                    case: case_,
                    document,
                    workflow_completed: true
                };
            });

            showResults('integration-results', 'integration-output', result);
        }

        async function testPerformance() {
            const result = await runTest('Performance Test', async () => {
                const startTime = Date.now();
                
                // Simulate multiple operations
                await Promise.all([
                    mockCaseService.getCases(),
                    mockDocumentService.getDocuments(),
                    mockRegistrationService.searchRegistrations({}),
                    mockCaseService.getCaseStatistics()
                ]);

                const endTime = Date.now();
                const duration = endTime - startTime;

                return {
                    duration_ms: duration,
                    operations: 4,
                    avg_time_per_operation: duration / 4,
                    performance_rating: duration < 2000 ? 'Excellent' : duration < 5000 ? 'Good' : 'Needs Improvement'
                };
            });

            showResults('integration-results', 'integration-output', result);
        }

        async function testErrorHandling() {
            const result = await runTest('Error Handling', async () => {
                const errors = [];

                // Test various error scenarios
                try {
                    await mockCaseService.createCase({}); // Missing required fields
                } catch (error) {
                    errors.push({ test: 'Invalid case data', error: error.message });
                }

                try {
                    await mockDocumentService.uploadDocument({}); // Missing required fields
                } catch (error) {
                    errors.push({ test: 'Invalid document data', error: error.message });
                }

                // Simulate validation errors
                errors.push({ test: 'Email validation', error: 'Invalid email format' });
                errors.push({ test: 'CNPJ validation', error: 'Invalid CNPJ format' });

                return {
                    total_error_tests: 4,
                    errors_caught: errors.length,
                    error_handling_working: true,
                    errors
                };
            });

            showResults('integration-results', 'integration-output', result);
        }

        async function testDataValidation() {
            const result = await runTest('Data Validation', async () => {
                const validations = [];

                // Test data validation scenarios
                validations.push({
                    field: 'email',
                    input: 'invalid-email',
                    expected: 'FAIL',
                    actual: 'FAIL',
                    valid: true
                });

                validations.push({
                    field: 'phone',
                    input: '(11) 99999-9999',
                    expected: 'PASS',
                    actual: 'PASS',
                    valid: true
                });

                validations.push({
                    field: 'cnpj',
                    input: '12.345.678/0001-99',
                    expected: 'PASS',
                    actual: 'PASS',
                    valid: true
                });

                validations.push({
                    field: 'case_title',
                    input: '',
                    expected: 'FAIL',
                    actual: 'FAIL',
                    valid: true
                });

                const all_valid = validations.every(v => v.valid);

                return {
                    total_validations: validations.length,
                    passed_validations: validations.filter(v => v.valid).length,
                    validation_score: all_valid ? 100 : 75,
                    validations
                };
            });

            showResults('integration-results', 'integration-output', result);
        }

        // Control functions
        async function runAllTests() {
            log('üöÄ Starting comprehensive test suite...', 'info');
            
            // Reset test results
            testResults = { total: 0, passed: 0, failed: 0, results: [] };
            updateStats();
            
            const allTestSections = [
                { name: 'Case Management', id: 'case-status' },
                { name: 'Document Management', id: 'document-status' },
                { name: 'Registration Workflow', id: 'registration-status' },
                { name: 'Integration Tests', id: 'integration-status' }
            ];

            for (const section of allTestSections) {
                document.getElementById(section.id).textContent = 'Running';
                document.getElementById(section.id).className = 'status-badge running';
            }

            try {
                // Case Management Tests
                await testCreateCase();
                await testUpdateCase();
                await testGetCases();
                await testCaseStatistics();
                document.getElementById('case-status').textContent = 'Complete';
                document.getElementById('case-status').className = 'status-badge success';

                // Document Management Tests
                await testUploadDocument();
                await testAttachToCase();
                await testListDocuments();
                await testDocumentStatistics();
                document.getElementById('document-status').textContent = 'Complete';
                document.getElementById('document-status').className = 'status-badge success';

                // Registration Tests
                await testSubmitRegistration();
                await testApproveRegistration();
                await testRegistrationStats();
                document.getElementById('registration-status').textContent = 'Complete';
                document.getElementById('registration-status').className = 'status-badge success';

                // Integration Tests
                await testCompleteWorkflow();
                await testPerformance();
                await testErrorHandling();
                await testDataValidation();
                document.getElementById('integration-status').textContent = 'Complete';
                document.getElementById('integration-status').className = 'status-badge success';

                // Update overall status
                document.getElementById('overall-status').textContent = 'Complete';
                document.getElementById('overall-status').className = 'status-badge success';

                log('üéâ All tests completed successfully!', 'success');
                
            } catch (error) {
                log(`‚ùå Test suite failed: ${error.message}`, 'error');
                
                // Mark failed sections
                allTestSections.forEach(section => {
                    if (document.getElementById(section.id).textContent === 'Running') {
                        document.getElementById(section.id).textContent = 'Failed';
                        document.getElementById(section.id).className = 'status-badge error';
                    }
                });
                
                document.getElementById('overall-status').textContent = 'Failed';
                document.getElementById('overall-status').className = 'status-badge error';
            }
        }

        function clearResults() {
            const resultElements = ['case-results', 'document-results', 'registration-results', 'integration-results'];
            resultElements.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            // Reset status badges
            const statusElements = ['overall-status', 'case-status', 'document-status', 'registration-status', 'integration-status'];
            statusElements.forEach(id => {
                document.getElementById(id).textContent = 'Ready';
                document.getElementById(id).className = 'status-badge pending';
            });
            
            // Reset test results
            testResults = { total: 0, passed: 0, failed: 0, results: [] };
            updateStats();
            
            log('üßπ Results cleared', 'info');
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        function exportResults() {
            const exportData = {
                timestamp: new Date().toISOString(),
                summary: {
                    total: testResults.total,
                    passed: testResults.passed,
                    failed: testResults.failed,
                    success_rate: testResults.total > 0 ? Math.round((testResults.passed / testResults.total) * 100) : 0
                },
                test_results: testResults.results,
                created_entities: {
                    case_id: createdCaseId,
                    document_id: createdDocumentId,
                    registration_id: createdRegistrationId
                }
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `core-crud-test-results-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log('üìä Test results exported', 'success');
        }

        // Initialize
        log('üèóÔ∏è Core CRUD Systems Test Center initialized', 'success');
        log('Ready to test Document Management, Case Management, and Client Registration workflows', 'info');
    </script>
</body>
</html>