<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Center - D'Avila Reis Legal-as-a-Service Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h1 class="text-3xl font-bold text-red-600 mb-2">üß™ Legal-as-a-Service Test Center</h1>
            <p class="text-gray-600">D'Avila Reis Advogados - Hybrid Billing & Subscription Platform</p>
            <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-blue-800">
                    <strong>Status:</strong> <span id="connection-status" class="font-mono">Checking...</span> | 
                    <strong>Environment:</strong> Development | 
                    <strong>Database:</strong> <span id="db-status">Testing...</span>
                </p>
            </div>
        </div>

        <!-- Test Sections -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Phase 1: Subscription Management -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-green-600 mb-4">üìã Phase 1: Subscription Management</h2>
                
                <div class="space-y-4">
                    <div class="p-4 border rounded-lg">
                        <h3 class="font-semibold mb-2">Database Migration</h3>
                        <div class="space-y-2" id="migration-status">
                            <div class="text-sm text-gray-500">Ready to apply subscription schema...</div>
                        </div>
                        <button onclick="applyMigration()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                            Apply Migration
                        </button>
                    </div>

                    <div class="p-4 border rounded-lg">
                        <h3 class="font-semibold mb-2">Subscription Plans</h3>
                        <div class="space-y-2" id="subscription-plans">
                            <div class="text-sm text-gray-500">Loading plans...</div>
                        </div>
                        <button onclick="testSubscriptionPlans()" class="mt-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            Test Plans
                        </button>
                    </div>

                    <div class="p-4 border rounded-lg">
                        <h3 class="font-semibold mb-2">Admin Interface</h3>
                        <div class="space-y-2">
                            <a href="http://localhost:8080" target="_blank" class="block text-blue-600 hover:underline">
                                ‚Üí Open Main Application
                            </a>
                            <a href="http://localhost:8080/admin/subscriptions" target="_blank" class="block text-blue-600 hover:underline">
                                ‚Üí Admin Subscriptions Dashboard
                            </a>
                        </div>
                        <button onclick="testAdminInterface()" class="mt-2 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            Test Admin UI
                        </button>
                    </div>
                </div>
            </div>

            <!-- Phase 2: Payment Plans & Discounts -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-blue-600 mb-4">üí≥ Phase 2: Payment Plans & Discounts</h2>
                
                <div class="space-y-4">
                    <div class="p-4 border rounded-lg">
                        <h3 class="font-semibold mb-2">Payment Plan Calculator</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <label>Amount (R$):</label>
                            <input type="number" id="payment-amount" class="border rounded px-2 py-1" value="15000">
                            <label>Installments:</label>
                            <input type="number" id="payment-installments" class="border rounded px-2 py-1" value="6">
                            <label>Interest (%):</label>
                            <input type="number" id="payment-interest" class="border rounded px-2 py-1" value="2" step="0.1">
                        </div>
                        <button onclick="calculatePaymentPlan()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Calculate Plan
                        </button>
                        <div id="payment-result" class="mt-2 text-sm text-gray-600"></div>
                    </div>

                    <div class="p-4 border rounded-lg">
                        <h3 class="font-semibold mb-2">Discount Engine</h3>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <label>Subscription Tier:</label>
                            <select id="sub-tier" class="border rounded px-2 py-1">
                                <option value="basic">Basic</option>
                                <option value="professional">Professional</option>
                                <option value="enterprise">Enterprise</option>
                            </select>
                            <label>Litigation Type:</label>
                            <select id="litigation-type" class="border rounded px-2 py-1">
                                <option value="labor_litigation">Labor Litigation</option>
                                <option value="corporate_litigation">Corporate Litigation</option>
                                <option value="civil_litigation">Civil Litigation</option>
                            </select>
                            <label>Original Amount:</label>
                            <input type="number" id="original-amount" class="border rounded px-2 py-1" value="10000">
                        </div>
                        <button onclick="calculateDiscount()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Calculate Discount
                        </button>
                        <div id="discount-result" class="mt-2 text-sm text-gray-600"></div>
                    </div>
                </div>
            </div>

            <!-- Phase 3: Business Intelligence -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-purple-600 mb-4">üìä Phase 3: Business Intelligence</h2>
                
                <div class="space-y-4">
                    <div class="p-4 border rounded-lg">
                        <h3 class="font-semibold mb-2">MRR Tracking</h3>
                        <div class="space-y-2" id="mrr-metrics">
                            <div class="text-sm text-gray-500">Loading MRR data...</div>
                        </div>
                        <button onclick="testMRR()" class="mt-2 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                            Calculate MRR
                        </button>
                    </div>

                    <div class="p-4 border rounded-lg">
                        <h3 class="font-semibold mb-2">Cross-sell Analytics</h3>
                        <div class="space-y-2" id="crosssell-metrics">
                            <div class="text-sm text-gray-500">Loading cross-sell data...</div>
                        </div>
                        <button onclick="testCrossSell()" class="mt-2 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                            Analyze Cross-sell
                        </button>
                    </div>
                </div>
            </div>

            <!-- Database Testing -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-red-600 mb-4">üóÑÔ∏è Database Testing</h2>
                
                <div class="space-y-4">
                    <div class="p-4 border rounded-lg">
                        <h3 class="font-semibold mb-2">Connection Status</h3>
                        <div class="space-y-2" id="db-connection">
                            <div class="text-sm text-gray-500">Testing connection...</div>
                        </div>
                        <button onclick="testDatabase()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                            Test Database
                        </button>
                    </div>

                    <div class="p-4 border rounded-lg">
                        <h3 class="font-semibold mb-2">Schema Status</h3>
                        <div class="space-y-2" id="schema-status">
                            <div class="text-sm text-gray-500">Checking schema...</div>
                        </div>
                        <button onclick="checkSchema()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                            Check Schema
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Results -->
        <div class="mt-8 bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">üìã Test Results</h2>
            <div id="test-results" class="font-mono text-sm bg-gray-100 p-4 rounded-lg max-h-96 overflow-y-auto">
                <div class="text-gray-500">Test results will appear here...</div>
            </div>
            <button onclick="clearResults()" class="mt-4 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                Clear Results
            </button>
        </div>
    </div>

    <script>
        // Initialize Supabase
        const SUPABASE_URL = "https://cmgtjqycneerfdxmdmwp.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtZ3RqcXljbmVlcmZkeG1kbXdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk5MjM5MzcsImV4cCI6MjA2NTQ5OTkzN30.iYW8plD4fm80ljPUQPl3HU7yJtFKZehKkkEcGohz5OI";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message, type = 'info') {
            const results = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            const typeColors = {
                'info': 'text-blue-600',
                'success': 'text-green-600', 
                'error': 'text-red-600',
                'warning': 'text-yellow-600'
            };
            results.innerHTML += `<div class="${typeColors[type]}"><span class="text-gray-500">[${timestamp}]</span> ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '<div class="text-gray-500">Test results cleared...</div>';
        }

        // Database connection test
        async function testDatabase() {
            log('üîó Testing database connection...', 'info');
            try {
                const { data, error } = await supabase.from('clients').select('count(*)', { count: 'exact', head: true });
                if (error) throw error;
                log('‚úÖ Database connection successful', 'success');
                document.getElementById('connection-status').textContent = 'Connected ‚úÖ';
                document.getElementById('db-status').textContent = 'Online ‚úÖ';
            } catch (error) {
                log(`‚ùå Database connection failed: ${error.message}`, 'error');
                document.getElementById('connection-status').textContent = 'Failed ‚ùå';
                document.getElementById('db-status').textContent = 'Error ‚ùå';
            }
        }

        // Schema checking
        async function checkSchema() {
            log('üóÑÔ∏è Checking database schema...', 'info');
            const tables = ['subscription_plans', 'client_subscriptions', 'subscription_usage', 'payment_installments'];
            
            for (const table of tables) {
                try {
                    const { data, error } = await supabase.from(table).select('*').limit(1);
                    if (error) {
                        log(`‚ö†Ô∏è Table ${table}: ${error.message}`, 'warning');
                    } else {
                        log(`‚úÖ Table ${table}: Available`, 'success');
                    }
                } catch (error) {
                    log(`‚ùå Table ${table}: Error - ${error.message}`, 'error');
                }
            }
        }

        // Apply database migration
        async function applyMigration() {
            log('üöÄ Applying subscription management migration...', 'info');
            
            const migrationSQL = `
            -- LEGAL-AS-A-SERVICE SUBSCRIPTION MANAGEMENT SCHEMA
            BEGIN;
            
            -- Subscription Plans Table
            CREATE TABLE IF NOT EXISTS public.subscription_plans (
                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                name VARCHAR(255) NOT NULL,
                tier VARCHAR(50) NOT NULL CHECK (tier IN ('basic', 'professional', 'enterprise')),
                category VARCHAR(100) NOT NULL CHECK (category IN ('labor_law', 'corporate_law', 'full_service')),
                monthly_price DECIMAL(10,2) NOT NULL,
                yearly_price DECIMAL(10,2),
                description TEXT,
                features JSONB DEFAULT '{}',
                consulting_hours_quota INTEGER DEFAULT 0,
                document_review_quota INTEGER DEFAULT 0,
                legal_questions_quota INTEGER DEFAULT 0,
                litigation_discount_percentage DECIMAL(5,2) DEFAULT 0,
                is_active BOOLEAN DEFAULT TRUE,
                created_at TIMESTAMP DEFAULT NOW(),
                updated_at TIMESTAMP DEFAULT NOW()
            );
            
            -- Insert default subscription plans
            INSERT INTO public.subscription_plans (name, tier, category, monthly_price, yearly_price, description, consulting_hours_quota, document_review_quota, legal_questions_quota, litigation_discount_percentage, features) VALUES
            ('B√°sico Trabalhista', 'basic', 'labor_law', 899.00, 9590.00, 'Consultoria b√°sica em direito trabalhista com desconto em lit√≠gios', 2, 5, 10, 15.00, '{"compliance_alerts": true, "basic_templates": true, "email_support": true}'),
            ('Profissional Trabalhista', 'professional', 'labor_law', 1899.00, 20290.00, 'Consultoria avan√ßada em direito trabalhista com maior desconto', 5, 15, 25, 25.00, '{"compliance_alerts": true, "premium_templates": true, "priority_support": true, "monthly_reports": true}'),
            ('B√°sico Empresarial', 'basic', 'corporate_law', 1299.00, 13890.00, 'Consultoria b√°sica em direito empresarial', 3, 8, 15, 15.00, '{"contract_templates": true, "basic_compliance": true, "email_support": true}'),
            ('Profissional Empresarial', 'professional', 'corporate_law', 2499.00, 26990.00, 'Consultoria avan√ßada em direito empresarial', 8, 20, 40, 25.00, '{"advanced_templates": true, "compliance_monitoring": true, "priority_support": true, "legal_updates": true}'),
            ('Empresarial Completo', 'enterprise', 'full_service', 4999.00, 53990.00, 'Servi√ßo jur√≠dico completo com m√°ximo desconto em lit√≠gios', 20, 50, 100, 30.00, '{"full_legal_support": true, "dedicated_lawyer": true, "24h_support": true, "custom_contracts": true, "litigation_support": true}')
            ON CONFLICT DO NOTHING;
            
            COMMIT;
            `;
            
            try {
                const { data, error } = await supabase.rpc('exec_sql', { sql: migrationSQL });
                if (error) throw error;
                
                log('‚úÖ Migration applied successfully!', 'success');
                document.getElementById('migration-status').innerHTML = '<div class="text-sm text-green-600">‚úÖ Migration completed</div>';
                
                // Test the plans immediately
                setTimeout(testSubscriptionPlans, 1000);
                
            } catch (error) {
                log(`‚ùå Migration failed: ${error.message}`, 'error');
                log('‚ö†Ô∏è Please apply the migration manually in Supabase SQL Editor', 'warning');
                document.getElementById('migration-status').innerHTML = '<div class="text-sm text-red-600">‚ùå Migration failed - apply manually</div>';
            }
        }

        // Subscription plans testing
        async function testSubscriptionPlans() {
            log('üìã Testing subscription plans...', 'info');
            
            try {
                const { data: plans, error } = await supabase
                    .from('subscription_plans')
                    .select('*')
                    .eq('is_active', true)
                    .order('monthly_price');
                
                if (error) throw error;
                
                log(`‚úÖ Found ${plans.length} subscription plans`, 'success');
                
                const plansContainer = document.getElementById('subscription-plans');
                plansContainer.innerHTML = '';
                
                plans.forEach(plan => {
                    plansContainer.innerHTML += `
                        <div class="text-sm border-l-4 border-blue-500 pl-2 mb-2">
                            <strong>${plan.name}</strong> (${plan.tier})<br>
                            <span class="text-gray-600">R$ ${plan.monthly_price} | ${plan.litigation_discount_percentage}% desconto</span>
                        </div>
                    `;
                });
                
                log('üìä Plans loaded in UI successfully', 'success');
                
            } catch (error) {
                log(`‚ùå Failed to fetch subscription plans: ${error.message}`, 'error');
                document.getElementById('subscription-plans').innerHTML = '<div class="text-sm text-red-600">Error loading plans</div>';
            }
        }
        
        // Test admin interface
        function testAdminInterface() {
            log('üéõÔ∏è Testing admin interface...', 'info');
            log('üëÄ Check the browser window for admin subscription dashboard', 'info');
            log('üîó Admin interface should show subscription analytics and plan management', 'info');
        }

        // Payment plan calculator
        function calculatePaymentPlan() {
            const amount = parseFloat(document.getElementById('payment-amount').value);
            const installments = parseInt(document.getElementById('payment-installments').value);
            const interestRate = parseFloat(document.getElementById('payment-interest').value) / 100;
            
            log(`üí≥ Calculating payment plan: R$ ${amount.toLocaleString('pt-BR')} in ${installments} installments at ${(interestRate * 100)}% monthly`, 'info');
            
            const monthlyPayment = interestRate > 0 
                ? (amount * interestRate * Math.pow(1 + interestRate, installments)) / (Math.pow(1 + interestRate, installments) - 1)
                : amount / installments;
            
            const totalWithInterest = monthlyPayment * installments;
            const totalInterest = totalWithInterest - amount;
            
            const result = `
                Monthly Payment: R$ ${monthlyPayment.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                Total with Interest: R$ ${totalWithInterest.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                Total Interest: R$ ${totalInterest.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
            `;
            
            document.getElementById('payment-result').innerHTML = result.replace(/\n/g, '<br>');
            log(`‚úÖ Payment plan calculated successfully`, 'success');
        }

        // Discount calculator
        function calculateDiscount() {
            const tier = document.getElementById('sub-tier').value;
            const litigationType = document.getElementById('litigation-type').value;
            const originalAmount = parseFloat(document.getElementById('original-amount').value);
            
            // Discount matrix (from roadmap)
            const discountMatrix = {
                basic: {
                    labor_litigation: 15,
                    corporate_litigation: 5,
                    civil_litigation: 0
                },
                professional: {
                    labor_litigation: 25,
                    corporate_litigation: 10,
                    civil_litigation: 5
                },
                enterprise: {
                    labor_litigation: 30,
                    corporate_litigation: 30,
                    civil_litigation: 25
                }
            };
            
            const discountPercentage = discountMatrix[tier]?.[litigationType] || 0;
            const discountAmount = originalAmount * (discountPercentage / 100);
            const finalAmount = originalAmount - discountAmount;
            
            log(`üí∞ Calculating discount: ${tier} tier, ${litigationType}, R$ ${originalAmount.toLocaleString('pt-BR')}`, 'info');
            
            const result = `
                Discount: ${discountPercentage}%
                Discount Amount: R$ ${discountAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                Final Amount: R$ ${finalAmount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
            `;
            
            document.getElementById('discount-result').innerHTML = result.replace(/\n/g, '<br>');
            log(`‚úÖ Discount calculated: ${discountPercentage}% off`, 'success');
        }

        // MRR testing
        function testMRR() {
            log('üìä Testing MRR calculations...', 'info');
            // Placeholder for now
            log('‚ö†Ô∏è MRR calculations will be implemented with subscription data', 'warning');
        }

        // Cross-sell testing
        function testCrossSell() {
            log('üéØ Testing cross-sell analytics...', 'info');
            // Placeholder for now
            log('‚ö†Ô∏è Cross-sell analytics will be implemented with subscription data', 'warning');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Legal-as-a-Service Test Center initialized', 'success');
            testDatabase();
        });
    </script>
</body>
</html>